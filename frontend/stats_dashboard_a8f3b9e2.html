<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            padding: 16px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 4px;
            color: #fff;
        }
        
        .subtitle {
            color: #9ca3af;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .refresh-btn {
            padding: 8px 16px;
            background: #22c55e;
            color: #052e16;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .refresh-btn:hover {
            background: #16a34a;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            background: #1e293b;
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 8px;
            padding: 12px;
        }
        
        .stat-card h3 {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #22c55e;
        }
        
        .section {
            background: #1e293b;
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .section h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #fff;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .table th {
            text-align: left;
            padding: 8px;
            background: #0f172a;
            color: #9ca3af;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table td {
            padding: 8px;
            border-top: 1px solid rgba(148,163,184,0.1);
        }
        
        .table tr:hover {
            background: rgba(34,197,94,0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(34,197,94,0.2);
            color: #22c55e;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge.warning {
            background: rgba(245,158,11,0.2);
            color: #f59e0b;
        }
        
        .badge.error {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }
        
        .badge.method {
            background: rgba(59,130,246,0.2);
            color: #3b82f6;
        }
        
        .resource-tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(139,92,246,0.2);
            color: #a78bfa;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 6px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .error {
            padding: 16px;
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 8px;
            color: #ef4444;
        }
        
        .timestamp {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .log-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .clubs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .club-card {
            background: #1e293b;
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        
        .club-card:hover {
            transform: translateY(-2px);
            border-color: rgba(34,197,94,0.3);
        }
        
        .club-header {
            position: relative;
            height: 100px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            overflow: hidden;
        }
        
        .club-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .club-info {
            padding: 12px;
        }
        
        .club-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .club-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 12px;
        }
        
        .club-stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .club-books {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
        }
        
        .book-mini-card {
            aspect-ratio: 2/3;
            border-radius: 6px;
            overflow: hidden;
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            position: relative;
            cursor: help;
        }
        
        .book-mini-card:hover {
            box-shadow: 0 0 0 2px #22c55e;
        }
        
        .book-mini-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .book-mini-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
            .clubs-grid {
                grid-template-columns: 1fr;
            }
        }
        
        code {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Analytics Dashboard</h1>
        <p class="subtitle">Book Club Mini App - –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</p>
        
        <button class="refresh-btn" onclick="loadStats()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        
        <div id="loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="content" style="display: none;">
            
            <!-- –ü–ª–∏—Ç–∫–∏ –∫–ª—É–±—ñ–≤ –∑ –∫–Ω–∏–∂–∫–∞–º–∏ -->
            <div id="clubs-cards" class="clubs-grid"></div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–ö–ª—É–±—ñ–≤</h3>
                    <div class="stat-value" id="clubs-count">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>–ö–Ω–∏–∂–æ–∫</h3>
                    <div class="stat-value" id="books-count">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>–í—ñ–¥–≥—É–∫—ñ–≤</h3>
                    <div class="stat-value" id="reviews-count">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
                    <div class="stat-value" id="unique-users">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>–í—ñ–¥–∫—Ä–∏—Ç—Ç—ñ–≤ –¥–æ–¥–∞—Ç–∫—É</h3>
                    <div class="stat-value" id="app-opens">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>–ù–æ–≤–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
                    <div class="stat-value" id="new-users">0</div>
                </div>
            </div>
            
            <div class="section">
                <h2>üìö –ö–ª—É–±–∏ (—Ç–æ–ø –∑–∞ –ø–µ—Ä–µ–≥–ª—è–¥–∞–º–∏)</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞ –∫–ª—É–±—É</th>
                            <th style="text-align: center;">–£—á–∞—Å–Ω–∏–∫—ñ–≤</th>
                            <th style="text-align: center;">–ö–Ω–∏–∂–æ–∫</th>
                            <th style="text-align: center;">–ü–µ—Ä–µ–≥–ª—è–¥—ñ–≤</th>
                            <th style="text-align: right;">–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="clubs-table"></tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>üìñ –ö–Ω–∏–∂–∫–∏ (—Ç–æ–ø –∑–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é)</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞ –∫–Ω–∏–∂–∫–∏</th>
                            <th>–ö–ª—É–±</th>
                            <th style="text-align: center;">–ü–µ—Ä–µ–≥–ª—è–¥—ñ–≤</th>
                            <th style="text-align: center;">–ü–æ–∑–∏—á–∞–Ω—å</th>
                            <th style="text-align: center;">–í—ñ–¥–≥—É–∫—ñ–≤</th>
                        </tr>
                    </thead>
                    <tbody id="books-table"></tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>‚ö° –û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (50 –ø–æ–¥—ñ–π)</h2>
                <div class="log-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 140px;">–ß–∞—Å</th>
                                <th style="width: 150px;">–¢–∏–ø</th>
                                <th>–î–µ—Ç–∞–ª—ñ</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table"></tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const d = new Date(isoString);
            return d.toLocaleString('uk-UA', { 
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTime(isoString) {
            if (!isoString) return 'N/A';
            const d = new Date(isoString);
            return d.toLocaleTimeString('uk-UA', { 
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function getActivityTypeLabel(type) {
            const labels = {
                'club_view': 'üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–¥ –∫–ª—É–±—É',
                'book_view': 'üìñ –ü–µ—Ä–µ–≥–ª—è–¥ –∫–Ω–∏–∂–∫–∏',
                'review_created': '‚≠ê –ù–æ–≤–∏–π –≤—ñ–¥–≥—É–∫',
                'member_joined': 'üë• –ü—Ä–∏—î–¥–Ω–∞–≤—Å—è',
                'book_borrowed': 'üìö –í–∑—è–≤ –∫–Ω–∏–≥—É',
                'book_returned': '‚úÖ –ü–æ–≤–µ—Ä–Ω—É–≤ –∫–Ω–∏–≥—É',
                'app_opened': 'üöÄ –í—ñ–¥–∫—Ä–∏–≤ –¥–æ–¥–∞—Ç–æ–∫',
                'activity_feed_view': 'üì∞ –ü–µ—Ä–µ–≥–ª—è–Ω—É–≤ —Å—Ç—Ä—ñ—á–∫—É'
            };
            return labels[type] || type;
        }
        
        async function loadStats() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';
            
            try {
                const response = await fetch('/api/internal/analytics');
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                
                // Clubs cards with books
                const clubsCards = document.getElementById('clubs-cards');
                clubsCards.innerHTML = '';
                
                const clubsArray = Object.entries(data.clubs || {})
                    .map(([id, club]) => ({ id, ...club }))
                    .sort((a, b) => (b.views || 0) - (a.views || 0));
                
                clubsArray.forEach(club => {
                    const clubCard = document.createElement('div');
                    clubCard.className = 'club-card';
                    
                    // Club header with cover
                    let headerContent = '';
                    if (club.cover_url) {
                        headerContent = `<img src="${club.cover_url}" class="club-cover" alt="${club.name}">`;
                    } else {
                        headerContent = '<div class="club-cover" style="display: flex; align-items: center; justify-content: center; font-size: 48px;">üìö</div>';
                    }
                    
                    // Books mini cards
                    let booksHtml = '';
                    const books = club.books || {};
                    const booksArray = Object.entries(books).slice(0, 6); // Show max 6 books
                    
                    if (booksArray.length > 0) {
                        booksHtml = '<div class="club-books">';
                        booksArray.forEach(([bookId, book]) => {
                            if (book.cover_url) {
                                booksHtml += `
                                    <div class="book-mini-card" title="${book.title}">
                                        <img src="${book.cover_url}" class="book-mini-cover" alt="${book.title}">
                                    </div>
                                `;
                            } else {
                                booksHtml += `
                                    <div class="book-mini-card" title="${book.title}">
                                        <div class="book-mini-placeholder">üìñ</div>
                                    </div>
                                `;
                            }
                        });
                        booksHtml += '</div>';
                    }
                    
                    clubCard.innerHTML = `
                        <div class="club-header">
                            ${headerContent}
                        </div>
                        <div class="club-info">
                            <div class="club-name">${club.name || 'Unnamed'}</div>
                            <div class="club-stats">
                                <div class="club-stat-item">
                                    <span>üë•</span>
                                    <span>${club.members_count || 0}</span>
                                </div>
                                <div class="club-stat-item">
                                    <span>üìö</span>
                                    <span>${club.books_count || 0}</span>
                                </div>
                                <div class="club-stat-item">
                                    <span>üëÅÔ∏è</span>
                                    <span>${club.views || 0}</span>
                                </div>
                            </div>
                            ${booksHtml}
                        </div>
                    `;
                    clubsCards.appendChild(clubCard);
                });
                
                // Overview stats
                document.getElementById('clubs-count').textContent = Object.keys(data.clubs || {}).length;
                document.getElementById('books-count').textContent = Object.keys(data.books || {}).length;
                document.getElementById('reviews-count').textContent = (data.reviews_total || 0).toLocaleString();
                document.getElementById('unique-users').textContent = (data.unique_users?.length || 0).toLocaleString();
                
                // –ù–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏: –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –¥–æ–¥–∞—Ç–∫—É
                const totalAppOpens = Object.values(data.daily_activity || {}).reduce((sum, day) => sum + (day.app_opens || 0), 0);
                const totalNewUsers = Object.values(data.daily_activity || {}).reduce((sum, day) => sum + (day.new_users || 0), 0);
                document.getElementById('app-opens').textContent = totalAppOpens.toLocaleString();
                document.getElementById('new-users').textContent = totalNewUsers.toLocaleString();
                
                // Clubs table
                const clubsTable = document.getElementById('clubs-table');
                clubsTable.innerHTML = '';
                
                const clubsTableArray = Object.entries(data.clubs || {})
                    .map(([id, club]) => ({ id, ...club }))
                    .sort((a, b) => (b.views || 0) - (a.views || 0))
                    .slice(0, 20);
                
                if (clubsTableArray.length === 0) {
                    clubsTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
                } else {
                    clubsTableArray.forEach(club => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${club.name || 'Unnamed'}</strong></td>
                            <td style="text-align: center;">${club.members_count || 0}</td>
                            <td style="text-align: center;">${club.books_count || 0}</td>
                            <td style="text-align: center;"><span class="badge">${club.views || 0}</span></td>
                            <td style="text-align: right; font-size: 11px; color: #9ca3af;">${formatDate(club.last_activity)}</td>
                        `;
                        clubsTable.appendChild(row);
                    });
                }
                
                // Books table
                const booksTable = document.getElementById('books-table');
                booksTable.innerHTML = '';
                
                const booksArray = Object.entries(data.books || {})
                    .map(([id, book]) => ({ 
                        id, 
                        ...book,
                        activity_score: (book.views || 0) + (book.borrows || 0) * 2 + (book.reviews || 0) * 3
                    }))
                    .sort((a, b) => b.activity_score - a.activity_score)
                    .slice(0, 20);
                
                if (booksArray.length === 0) {
                    booksTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
                } else {
                    booksArray.forEach(book => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${book.title || 'Unnamed'}</strong></td>
                            <td><span class="resource-tag">${book.club_name || 'Unknown'}</span></td>
                            <td style="text-align: center;">${book.views || 0}</td>
                            <td style="text-align: center;">${book.borrows || 0}</td>
                            <td style="text-align: center;"><span class="badge">${book.reviews || 0}</span></td>
                        `;
                        booksTable.appendChild(row);
                    });
                }
                
                // Recent activity
                const activityTable = document.getElementById('activity-table');
                activityTable.innerHTML = '';
                
                const activities = data.recent_activity || [];
                
                if (activities.length === 0) {
                    activityTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #9ca3af;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
                } else {
                    activities.forEach(activity => {
                        const row = document.createElement('tr');
                        
                        let details = '';
                        if (activity.club) {
                            details += `<span class="resource-tag">${activity.club}</span> `;
                        }
                        if (activity.book) {
                            details += `<span class="resource-tag">${activity.book}</span>`;
                        }
                        
                        row.innerHTML = `
                            <td style="font-size: 11px;">${formatTime(activity.timestamp)}</td>
                            <td><span class="badge method">${getActivityTypeLabel(activity.type)}</span></td>
                            <td>${details}</td>
                        `;
                        activityTable.appendChild(row);
                    });
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + err.message;
            }
        }
        
        // Load on page load
        loadStats();
        
        // Auto-refresh every 30 seconds
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
